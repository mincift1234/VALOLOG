<!doctype html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>VALOLOG</title>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
        <link rel="stylesheet" href="style.css" />
        <link rel="manifest" href="/manifest.webmanifest" />
        <meta name="theme-color" content="#1ea1f7" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
    </head>
    <body>
        <!-- 상단 네비 -->
        <nav>
            <div class="logo">VALOLOG</div>
            <ul class="menu">
                <li><a href="#" class="nav-link active" data-page="report">트롤 등록</a></li>
                <li><a href="#" class="nav-link" data-page="appeal">이의 신청</a></li>
                <li><a href="#" class="nav-link" data-page="lookup">트롤 조회</a></li>
                <!-- ✅ 추가: 관리자 메뉴(초기 숨김, 로그인+권한 시 JS가 표시) -->
                <li style="display: none">
                    <a href="#" class="nav-link" data-page="admin">
                        관리자 승인 <span id="adminBadge" class="badge hidden">0</span>
                    </a>
                </li>
            </ul>
            <div class="auth">
                <button id="btnLogin">로그인</button>
                <button id="btnLogout" class="hidden">로그아웃</button>
            </div>
        </nav>

        <!-- ▼▼▼ 추가: 모바일 전용 구분선 + 메뉴(데스크톱에는 숨김) ▼▼▼ -->
        <div class="mobile-divider"></div>
        <div class="mobile-menu">
            <a href="#" class="nav-link active" data-page="report">트롤 등록</a>
            <a href="#" class="nav-link" data-page="appeal">이의 신청</a>
            <a href="#" class="nav-link" data-page="lookup">트롤 조회</a>
            <a href="#" class="nav-link" data-page="admin" id="mobileAdminLink" style="display: none">
                관리자 승인 <span class="badge hidden" id="mobileAdminBadge">0</span>
            </a>
        </div>
        <!-- ▲▲▲ 추가 끝 ▲▲▲ -->

        <!-- 히어로 -->
        <section class="hero">
            <h1 id="heroTitle">트롤 신고 센터</h1>
            <p id="heroDesc">발로란트 트롤 유저를 등록하고, 모두가 쾌적한 게임 환경을 만들어요.</p>
        </section>

        <!-- 메인 컨테이너 -->
        <div class="main-container">
            <!-- 통계 열 -->
            <div class="stats" id="statsColumn">
                <div class="stat-card">
                    <p>오늘 등록</p>
                    <h3 id="todayCount">0</h3>
                </div>
                <div class="stat-card">
                    <p>이번 주 등록</p>
                    <h3 id="weekCount">0</h3>
                </div>
                <div class="stat-card">
                    <p>전체 등록</p>
                    <h3 id="totalCount">0</h3>
                </div>
            </div>

            <!-- 폼 / 컨텐츠 패널 -->
            <div class="form-section" id="panel">
                <!-- 페이지: 트롤 등록 -->
                <div class="page page-active" id="page-report">
                    <h2>트롤 등록하기</h2>

                    <label class="field-label" for="rRiotId">라이엇 ID</label>
                    <input id="rRiotId" type="text" placeholder="닉네임#태그" autocomplete="off" />

                    <label class="field-label" for="rCategory">카테고리</label>
                    <select id="rCategory">
                        <option value="">선택</option>
                        <option value="욕설">욕설</option>
                        <option value="고의 트롤">고의 트롤</option>
                        <option value="AFK/탈주">AFK/탈주</option>
                        <option value="불쾌한 닉네임">불쾌한 닉네임</option>
                        <option value="기타">기타</option>
                    </select>

                    <label class="field-label" for="rDesc">설명</label>
                    <textarea id="rDesc" rows="5" placeholder="상황을 구체적으로 적어주세요."></textarea>

                    <label class="field-label" for="rProof">증거 링크(필수)</label>
                    <input id="rProof" type="url" placeholder="영상 비공개 링크, 사진 다운로드 링크" />

                    <button id="btnReport" class="btn-submit">등록</button>
                </div>

                <!-- 페이지: 이의 신청 -->
                <div class="page" id="page-appeal">
                    <h2>이의 신청</h2>

                    <label class="field-label" for="aRiotId">라이엇 ID</label>
                    <input id="aRiotId" type="text" placeholder="닉네임#태그" autocomplete="off" />

                    <label class="field-label" for="aReason">사유</label>
                    <textarea id="aReason" rows="5" placeholder="오해가 있었다면 근거와 함께 설명해주세요."></textarea>

                    <label class="field-label" for="aProof">추가 증거 링크(필수)</label>
                    <input id="aProof" type="url" placeholder="영상 비공개 링크, 사진 다운로드 링크" />

                    <button id="btnAppeal" class="btn-submit">이의 신청</button>
                </div>

                <!-- 페이지: 트롤 조회 -->
                <div class="page" id="page-lookup">
                    <h2>트롤 조회</h2>

                    <label class="field-label" for="q">검색</label>
                    <input id="q" type="text" placeholder="닉네임 또는 설명 키워드" autocomplete="off" />

                    <div id="resultList" class="results-list" style="margin-top: 12px"></div>
                    <button id="btnMore" class="btn-submit hidden" style="margin-top: 12px">더 보기</button>
                </div>

                <!-- 페이지: 관리자 승인 (관리자 로그인 시 메뉴가 동적으로 나타남) -->
                <div class="page" id="page-admin">
                    <h2>승인 대기 목록</h2>
                    <div id="pendingList" class="results-list"></div>
                    <!-- 관리자 승인 페이지 내부(승인 대기 목록 아래) -->
                    <h2 style="margin-top: 28px">이의 신청 목록</h2>
                    <div id="appealList" class="results-list"></div>
                </div>
            </div>
        </div>

        <!-- 토스트 -->
        <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

        <!-- Firebase v9 (모듈) -->
        <script type="module" src="app.js"></script>

        <!-- ▼▼▼ 추가: 모바일 메뉴의 관리자 표시/배지 숫자 동기화(앱 JS 수정 없이) ▼▼▼ -->
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const desktopAdminItem = document.querySelector(
                    'ul.menu li a.nav-link[data-page="admin"]'
                )?.parentElement;
                const desktopBadge = document.getElementById("adminBadge");

                const mobileAdminLink = document.getElementById("mobileAdminLink");
                const mobileAdminBadge = document.getElementById("mobileAdminBadge");

                if (!desktopAdminItem || !mobileAdminLink) return;

                const syncVisibility = () => {
                    mobileAdminLink.style.display = desktopAdminItem.style.display || "";
                };
                const syncBadge = () => {
                    if (!desktopBadge || !mobileAdminBadge) return;
                    mobileAdminBadge.textContent = desktopBadge.textContent;
                    mobileAdminBadge.classList.toggle("hidden", desktopBadge.classList.contains("hidden"));
                };

                document.addEventListener("DOMContentLoaded", () => {
                    const y = document.getElementById("yearNow");
                    if (y) y.textContent = String(new Date().getFullYear());
                });

                // 초기 동기화
                syncVisibility();
                syncBadge();

                // 변화 감시해서 동기화
                new MutationObserver(syncVisibility).observe(desktopAdminItem, {
                    attributes: true,
                    attributeFilter: ["style", "class"]
                });
                if (desktopBadge) {
                    new MutationObserver(syncBadge).observe(desktopBadge, {
                        attributes: true,
                        attributeFilter: ["class"],
                        childList: true,
                        subtree: true,
                        characterData: true
                    });
                }
            });
        </script>
        <!-- ▲▲▲ 추가 끝 ▲▲▲ -->
        <!-- Footer -->
        <!-- Footer -->
        <footer class="site-footer">
            <div class="footer-inner">
                <div class="footer-section brand">
                    <div class="logo">VALOLOG</div>
                    <p class="tagline">발로란트 트롤 신고 · 조회 플랫폼</p>
                </div>

                <div class="footer-section contact-support">
                    <h4>문의 & 후원</h4>
                    <div class="social">
                        <!-- 이메일 아이콘 버튼 -->
                        <a href="mailto:valorantoskr@gmail.com" aria-label="이메일" class="social-btn">
                            <svg
                                width="20"
                                height="20"
                                viewBox="0 0 512 512"
                                fill="currentColor"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M502.3 190.8c3.9-2.9 9.3-0.3 9.3 4.6V432c0 26.5-21.5 48-48 48H48c-26.5 
                         0-48-21.5-48-48V195.4c0-4.9 5.4-7.5 9.3-4.6l197.4 
                         146.8c21.4 15.9 50.1 15.9 71.5 0l197.4-146.8zM256 
                         320c-8.2 0-16.4-2.6-23.4-7.9L32 180.3V80c0-26.5 
                         21.5-48 48-48h352c26.5 0 48 21.5 48 48v100.3L279.4 
                         312.1c-7 5.3-15.2 7.9-23.4 7.9z" />
                            </svg>
                        </a>
                    </div>
                </div>
            </div>

            <div class="footer-bottom">
                <div class="copy">© <span id="yearNow">2025</span> VALOLOG</div>
                <div class="footer-nav">
                    <!-- 헤더와 동일한 라우팅 동작( .nav-link ) -->
                    <a href="#" class="nav-link" data-page="report">트롤 등록</a>
                    <span>·</span>
                    <a href="#" class="nav-link" data-page="appeal">이의 신청</a>
                    <span>·</span>
                    <a href="#" class="nav-link" data-page="lookup">트롤 조회</a>
                    <span>·</span>
                    <a href="#" class="nav-link" data-page="admin" id="footerAdminLink" style="display: none"
                        >관리자 승인</a
                    >
                </div>
            </div>
        </footer>
        <script>
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", async () => {
                    try {
                        const reg = await navigator.serviceWorker.register("/sw.js");

                        // 새 버전 서비스워커가 오면 즉시 교체 + 자동 리로드
                        let refreshing = false;
                        navigator.serviceWorker.addEventListener("controllerchange", () => {
                            if (refreshing) return;
                            refreshing = true;
                            location.reload();
                        });

                        // 주기적으로 업데이트 체크 (15분마다)
                        setInterval(() => reg.update().catch(() => {}), 15 * 60 * 1000);
                    } catch (e) {
                        console.log("SW register failed", e);
                    }
                });
            }
        </script>
    </body>
</html>
